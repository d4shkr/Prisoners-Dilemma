# Prisoners-Dilemma

### Содержание
- [Описание](#описание)
- [Стек технологий](#стек-технологий)
- [Архитектура приложения](#архитектура-приложения)
- [База данных](#база-данных)

## Описание

Данное Web-приложение разработано для игры в повторяющуюся [Дилемму заключённого](https://en.wikipedia.org/wiki/Prisoner%27s_dilemma) с изменяемыми настройками. В приложении можно создавать как игры для двух человек, так и турниры на любое количество участников. Задача участников - максимизировать свой счёт.

## Стек технологий

- PHP 8.3
- JavaScript + Ajax
- HTML + CSS
- MySQL

## Архитектура приложения 

- `app/` 
    - `css/` 
        - `dilemma.css` - стиль для страницы `dilemma.php`
        - `index.css` - стиль для страницы `index.php`
        - `payoff.css` - стиль для матрицы выигрышей
        - `tournament.css` - стиль для страницы `tournament.php`
    - `php_functions/` 
        - `choose_betray.php` - функция, изменяющая выбор игрока на "предать" и вызывающая функцию `update_scores.php`
        - `choose_cooperate.php` - функция, изменяющая выбор игрока на "сотрудничать" и вызывающая функцию `update_scores.php`
        - `create_game.php` - функция, обрабатывающая запрос создания игры с выбранными параметрами в теле запроса, и возвращающая UUID созданной игры
        - `create_tournament.php` - функция, обрабатывающая запрос создания турнира с выбранными параметрами в теле запроса, и возвращающая UUID созданного турнира
        - `get_game_id.php` - вспомогательная функция, предназначенная для быстрого доступа к `GameId` через `PlayerId` в других функциях
        - `get_leaderboard_data.php` - функция, возвращающая JSON с данными, отображаемыми в таблице лидеров
        - `get_player_choice.php` - функция, возвращающая нынешнее состояние игрока в `dilemma.php`
        - `get_player_up_to_date.php` - функция, сообщающая клиенту, нужно ли ему запрашивать больше данных у сервера
        - `get_round.php` - функция, возвращающая номер текущего раунда (и общее количество раундов, если оно должно быть известно игроку)
        - `get_scoretable_data.php` - функция, возвращающая данные для отображения в таблице очков в `dilemma.php`
        - `get_tournament_id.php` - вспомогательная функция, предназначенная для быстрого доступа к `TournamentId` через `TournamentMemberId` в других функциях
        - `receive_player_message.php` - функция, которая достает из таблицы сообщение для игрока, обнуляет его и возвращает клиенту
        - `tournament_request_game.php` - эта функция проверяет фазу турнира и отсутствие привязанности участника турнира к какой-то игре, при выполнении этих условий ищет участнику турнира подходящего оппонента для новой игры, при нахождении которого создает для них игру, и в любом случае возвращает клиенту его статус
        - `update_member_name.php` - эта функция обрабатывает запрос на установку нового имени участнику турнира
        - `update_score.php` - эта функция проверяет, что оба игрока сделали свой выбор, и в зависимости от выбора определяет очки, которые получит каждый игрок, и сообщения, которые им нужно отобразить; в случае, если игроки - участники турнира, обновляет статус и очки участников, а также завершает турнир, если все участники отыграли все свои игры
    - `scripts/`
        - `dilemma.js` - скрипты для страницы `dilemma.php`, которые регулярно отправляют запросы серверу и обновляют визуал страницы
        - `index.js` - скрипты для страницы `index.php`, которые отправляют запросы серверу для создания игры
        - `tournament.js` - скрипты для страницы `tournament.php`, которые регулярно отправляют запросы серверу и обновляют визуал страницы
    - `db.php` - файл с подключением к базе данных
    - `dilemma.php` - страница с игрой в Дилемму заключенного. На странице находятся таблица выигрышей, таблица очков и кнопки выбора
    - `index.php` - главная страница сайта, на которой можно создать игру или турнир с выбранными настройками
    - `join.php` - страница, добавляющая игроков в игру или турнир и перенаправляющая на соответствующую страницу
    - `tournament.php` - страница турнира с таблицей лидеров, настройками турнира, возможностью изменения имени и подключения к игре в `dilemma.php`
- `conf.d/`
    - `my.cnf` - файл конфигурации MySQL
    - `php.conf` - файл конфигурации PHP
- `sql/` 
    - `dilemma.sql` - файл с инициализацией базы данных
- `docker-compose.yml` - файл с конфигурацией взаимодействия технологий
- `Dockerfile` - файл с установкой PHP и MySQLi

## База данных

### Таблица Dilemma

**Содержит информацию о конкретной игре и ее участниках.**

*Данные игры:*
- `GameId` - ID Игры
- `CurrentRound` - Номер текущего раунда
- `GamePhase` - Статус игры: 'Running' или 'Finished'

*Данные об игроках*
- `PayoffHistory_Player1` - JSON с историей выигрышей 1-го игркоа
- `PayoffHistory_Player2` - JSON с историей выигрышей 1-го игркоа
- `Score_Player1` - Общий балл 1-го игрока
- `Score_Player2` - Общий балл 2-го игрока
- `Status_Player1` - Статус игрока 1 в игре: -1 если еще не присоединился, 0 если еще не сделал ход, 1 если выбрал "Предать", 2 - если "Сотрудничать"
- `Status_Player2` - Статус игрока 2 в игре: -1 если езе не присоединился, 0 если еще не сделал ход, 1 если выбрал "Предать", 2 - если "Сотрудничать"
- `Message_Player1` - Сообщение, которое нужно отобразить 1-му игроку
- `Message_Player2` - Сообщение, которое нужно отобразить 2-му игроку
- `UpToDate_Player1` - булевая переменная, которая равна FALSE если этому игроку нужно обновить
- `UpToDate_Player2`

*Связь с турнирами:*

- `TournamentMemberId1` - ID участника турнира, связанное с данной игрой. NULL если игрок не является участником турнира.
- `TournamentMemberId2` 

*Настройки игры:*
- `MaxRounds` - Количество раундов в игре
- `BothBetrayPayoff` - Очки, которые получает игрок, если оба игрока выбрали "предательство"
- `BothCooperatePayoff` - Очки, которые получает игрок, если оба игрока выбрали "сотрудничество"
- `WasBetrayedPayoff` - Очки, которые получает игрок, если он выбрал "сотрудничество", а его оппонент - "предательство"
- `HasBetrayedPayoff` - Очки, которые получает игрок, если он выбрал "предательство", а его оппонент - "сотрудничество"
- `MaxRoundsKnown` - булевая переменная, которая равна FALSE, если количество раундов в игре скрыто от участников.

### Таблица Players

**Содержит информацию об игроках.**

- `PlayerId` - ID игрока
- `GameId` - ID игры, в которой он участвует
- `PlayerNum` - номер игрока: 1 или 2

### Таблица Tournaments

**Содержит информацию о турнирах и их участниках.**

- `TournamentId` - ID турнира
- `TournamentMemberIds` - JSON список участников турнира из таблицы TournamentMembers 
- `TournamentPhase` - статус турнира: 'Waiting', если не все участники присоединились, 'In Progress', если турнир ещё не закончен, 'Complete' - если закончен

*Настройки турнира:*
- `NumberOfMembers` - количество участников
- `NumberOfGamesPerMember` - количество игр, которые сыграет каждый участник

*Настройки игр в турнире: те же, что и в таблице Dilemma. Настройки дублируются при создании игр в турнире.*
- `MaxRounds` 
- `BothBetrayPayoff`
- `BothCooperatePayoff`
- `WasBetrayedPayoff`
- `HasBetrayedPayoff`
- `MaxRoundsKnown`

### Таблица TournamentMembers

**Содержит информацию об участниках турниира.**

- `TournamentMemberId` - ID участника турнира
- `TournamentId` - ID турнира, участником которого является игрок
- `Curr_PlayerId` - ID текущей игры, в которой в рамках турнира участвует игрок
- `MemberName` - отображаемое имя участника турнира
- `Score` - общий счет в турнире
- `NumberOfPlayedGames` - количество сыгранных в турнире игр
- `PreviousOpponentIds` - JSON список оппонентов, с которыми игрок недавно играл. Данная переменная нужна, чтобы в рамках турнира игроки могли поиграть с разными людьми
- `IsAvailable` - True, если участник может присоединиться к новой игре

### Связь таблиц

**Игра**, **Игрок**, **Турнир** и **Участник** турнира однозначно определяются своими ID. По ID Игрока можно получить ID Игры, по ID Участника турнира можно получить ID Турнира и ID Игрока (через который можно получить ID текущей Игры).